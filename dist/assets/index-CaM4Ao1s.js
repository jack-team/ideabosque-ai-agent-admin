import{o as J,p as Z,b as u,A as L,u as m,j as e,S as U,q as ee,s as D,t as V,v as te,w as ne,x as oe,y as se,n as de,z as ae,H as C,D as S,G as W,J as re,K as ie,L as ce,O as le,Q as _e,U as ue,V as me,W as pe,X as he,Y as xe}from"./libs-DoyQQ7D9.js";import{b as ye,c as R,S as fe,T as k,u as H,a as ve,d as je}from"./index-6qMI0c0s.js";import"./index-fj5aKeTe.js";var ge=Z();const O=J(ge),Q=u.createContext({}),B=()=>u.useContext(Q),be=()=>{const{modal:t}=L.useApp();ye(()=>new Promise((n,o)=>{t.confirm({title:"Are you sure you want to close?",content:"The current content will be lost after closing.",okText:"Close",onOk:()=>n(),onCancel:()=>o(),okButtonProps:{className:"shopify"},cancelButtonProps:{className:"shopify"}})}))},Ne="_edit_step_modal_kkp35_1",we="_edit_step_kkp35_1",Te="_edit_step_header_kkp35_20",Ce="_edit_step_content_kkp35_24",T={edit_step_modal:Ne,edit_step:we,edit_step_header:Te,edit_step_content:Ce},Se=t=>{const{message:n}=L.useApp(),[o]=R(),d=u.useRef(null),s=m(()=>d.current.getData()),a=m(()=>{var i;const r=s();if(!r.edges.length){n.error("The current flowchart is not completed.");return}(i=t.onSave)==null||i.call(t,r),o()});return be(),e.jsxs("div",{className:T.edit_step,children:[e.jsx("div",{className:T.edit_step_header,children:e.jsx(U,{children:e.jsx(fe,{type:"primary",onClick:a,children:"Save"})})}),e.jsx("div",{className:T.edit_step_content,children:e.jsx(Ft,{role:"child",ref:d,initialEdges:t.edges,initialNodes:t.nodes})})]})},ke=t=>{const{trigger:n,modal:o,...d}=t;return e.jsx(k,{centered:!0,modal:o,width:"100vw",hasFooter:!1,title:"Edit Step",trigger:n,className:T.edit_step_modal,children:e.jsx(Se,{...d})})},Ee={style:{stroke:"#0143EC",strokeWidth:2},markerEnd:{color:"#0143EC",type:ee.ArrowClosed}},E={target:"Target",source:"Source"},Pe=[{title:"Connection setting",valueType:"group",columns:[{title:"Enable",valueType:"switch",initialValue:!0,dataIndex:"connectionEnable"},{valueType:"dependency",name:["connectionEnable"],columns:({connectionEnable:t})=>{const n=[];return t&&n.push({title:"Types",valueType:"select",valueEnum:E,dataIndex:"connectionTypes",fieldProps:{mode:"multiple"},initialValue:Object.keys(E)}),n}}]}],Fe=t=>{const[n]=D.useForm(),[o]=R();return H(async()=>{var s;const d=await n.validateFields();(s=t.onSave)==null||s.call(t,d),o()}),e.jsx("div",{style:{padding:"24px 0 0 0"},children:e.jsx(V,{form:n,layout:"horizontal",columns:Pe,submitter:!1,initialValues:t.formData})})},A=t=>{const n=t.valueType,o=t.dependencys||[],d={valueType:n,width:t.width,title:t.title,tooltip:t.tooltip,dataIndex:t.name,valueEnum:t.valueEnum,fieldProps:t.fieldProps,initialValue:t.initialValue,formItemProps:{rules:t.rules}};return t.columns&&(d.columns=t.columns.map(A)),o.length&&(d.valueType="dependency",d.name=o.map(s=>s.name),d.columns=s=>o.filter(({name:r,values:i=[]})=>i.find(c=>c===s[r])).reduce((r,i)=>{const c=i.renders||[];return[...r,...c.map(A)]},[])),d},z=(t,n={})=>(t.forEach(o=>{var d;o.valueEnum&&(n=Object.assign(n,o.valueEnum)),(d=o.dependencys)==null||d.forEach(s=>{z(s.renders,n)})}),n),K=(t,n=[])=>(t.forEach(o=>{const d=o.dependencys||[],s=o.valueType||"text";d.length?d.forEach(a=>{K(a.renders,n)}):n.push({type:s,name:o.name})}),n),qe=(t={})=>(t=O(t),Object.keys(t).reduce((n,o)=>({...n,[o]:t[o].value}),{})),$e=(t,n,o)=>(Object.keys(t).map(d=>{const s=n.find(c=>c.name===d),a=t[d],r=(s==null?void 0:s.type)||"text",i={_type_:r,value:a};r==="select"&&(i.label=o[a]),t[d]=i}),t),Ie="_dynamic_form_1eu5x_1",Me={dynamic_form:Ie},Y=t=>{const{schemas:n=[],formData:o}=t,[d]=D.useForm(),[s]=R(),a=u.useMemo(()=>n.map(A),[n]),r=u.useMemo(()=>z(n),[n]),i=u.useMemo(()=>K(n),[n]);return H(async()=>{var _;let c=await d.validateFields();c=$e(c,i,r),await((_=t.onSubmit)==null?void 0:_.call(t,{formData:c})),s()}),e.jsx("div",{className:Me.dynamic_form,children:e.jsx(V,{form:d,submitter:!1,columns:a,initialValues:o})})},Oe="_tool_bar_container_122m1_1",Ae="_tool_bar_action_122m1_5",f={tool_bar_container:Oe,tool_bar_action:Ae},We=t=>{const{data:n}=t,o=n.values,{nodeType:d,autoOpenStepCanvas:s=!0}=o,{role:a,deleteNode:r,updateNodeData:i}=B(),[c]=ve(),_=m(async l=>{i(t.id,Object.assign(n,l))}),P=m(async l=>{n.values=Object.assign(n.values,l),_(n)}),F=m(async l=>{_(l)}),q=m(l=>{n.values.stepRealData=l,_(n)}),$=m(()=>{a==="parent"&&d==="step"&&s&&(o.autoOpenStepCanvas=!1,requestAnimationFrame(()=>{c.openModal(),_(n)}))}),I=te("ai-node-tool-bar",f.tool_bar_container);return ne($),e.jsx("div",{className:I,children:e.jsxs(U,{size:12,children:[e.jsx("div",{className:f.tool_bar_action,onClick:()=>r(t.id),children:e.jsx(oe,{})}),a==="parent"&&e.jsx(ke,{...n.values.stepRealData,modal:c,onSave:q,trigger:e.jsx("div",{className:f.tool_bar_action,children:e.jsx(se,{})})}),e.jsx(k,{title:"Edit Node",okText:"Save",width:t.editModalWidth,trigger:e.jsx("div",{className:f.tool_bar_action,children:e.jsx(de,{})}),children:e.jsx(Y,{...t,onSubmit:P})}),e.jsx(k,{title:"Settings",okText:"Save",trigger:e.jsx("div",{className:f.tool_bar_action,children:e.jsx(ae,{})}),children:e.jsx(Fe,{formData:t.data,onSave:F})})]})})},Re=t=>{const{connectionEnable:n=!0,connectionTypes:o=Object.keys(E)}=t.data,d=o.includes("target"),s=o.includes("source");return e.jsxs(u.Fragment,{children:[n&&d&&e.jsx("div",{className:"flow_handle_left",children:e.jsx(C,{type:"target",position:S.Left,className:"flow_handle",isConnectable:t.isConnectable})}),n&&s&&e.jsxs("div",{className:"flow_handle_right",children:[e.jsx(C,{type:"source",position:S.Right,className:"flow_handle",isConnectable:t.isConnectable}),e.jsx(W,{})]})]})},X=[{type:"step",icon:"StepForwardOutlined",title:"Step",modalWidth:420,desc:"Execute the corresponding process according to the different branches created.",formSchema:[{title:"Name",name:"name",rules:[{required:!0}]},{title:"Description",name:"description",rules:[{required:!0}]},{name:"conditions",valueType:"formList",fieldProps:{creatorButtonProps:{creatorButtonText:"Add condition"}},columns:[{valueType:"group",columns:[{title:"Condition",name:"condition",fieldProps:{placeholder:"Please enter a condition"},width:"md",rules:[{required:!0}]}]}]}]},{type:"prompt",title:"Prompt",icon:"SendOutlined",modalWidth:"420px",desc:"Prompt the AI what to do or say.",formSchema:[{title:"Type",name:"type",valueType:"radio",valueEnum:{prompt:"Prompt",text:"Text"},initialValue:"prompt",rules:[{required:!0}]},{dependencys:[{name:"type",values:["text"],renders:[{title:"Text",name:"text",rules:[{required:!0}]}]},{name:"type",values:["prompt"],renders:[{title:"Prompt",name:"prompt",rules:[{required:!0}]}]}]}]},{type:"ui",title:"UI",icon:"KubernetesOutlined",desc:"The UI components within the AI assistant can be used as a data source to obtain data.",modalWidth:500,formSchema:[{valueType:"select",title:"Component",name:"name",rules:[{required:!0,message:"Please select Component"}],valueEnum:{UploadFile:"Upload File",GooglePlace:"Google Place",QuestionGroup:"Question Group"}},{dependencys:[{name:"name",values:["UploadFile","GooglePlace","QuestionGroup"],renders:[{title:"Text",name:"text",tooltip:"Description information of the selection component."},{title:"Wait For",name:"waitFor",tooltip:"Wait for the data output by the UI component.",rules:[{required:!0}]}]},{name:"name",values:["UploadFile"],renders:[{title:"Question",name:"question"},{title:"Contact uuid",name:"contactUuid",rules:[{required:!0}]}]},{name:"name",values:["GooglePlace"],renders:[{title:"Keyword",name:"keyword",tooltip:"The default search keywords for Google Place.",rules:[{required:!0}]},{title:"Google Api Key",name:"googleApiKey",rules:[{required:!0}]}]},{name:"name",values:["QuestionGroup"],renders:[{title:"Question Group uuid",name:"questionGroupUuid",rules:[{required:!0}]}]}]}]},{type:"branch",icon:"BranchesOutlined",title:"Branch",modalWidth:420,desc:"Execute the corresponding process according to the different branches created.",formSchema:[{title:"Name",name:"name",rules:[{required:!0}]},{title:"Text",name:"text",rules:[{required:!0}]},{name:"conditions",valueType:"formList",fieldProps:{creatorButtonProps:{creatorButtonText:"Add condition"}},columns:[{valueType:"group",columns:[{title:"Condition",name:"condition",fieldProps:{placeholder:"Please enter a condition"},width:"md",rules:[{required:!0}]}]}]}]},{type:"action",icon:"FunctionOutlined",title:"Action",desc:"Obtain or process data by calling backend interfaces or methods.",formSchema:[{title:"Type",name:"type",rules:[{required:!0}]},{title:"Text",name:"text",rules:[{required:!0}]}]},{type:"transform",icon:"BlockOutlined",title:"Transform",desc:"Convert the input data",formSchema:[{title:"Type",name:"type",rules:[{required:!0}]},{title:"Text",name:"text",rules:[{required:!0}]}]}],Be="_node_layout_wrapper_xpd8g_1",Ge="_tool_bar_xpd8g_13",Le="_node_layout_xpd8g_1",Ue="_node_layout_body_xpd8g_29",b={node_layout_wrapper:Be,tool_bar:Ge,node_layout:Le,node_layout_body:Ue};function g(t){const{data:n,children:o,handler:d=!0}=t,s=n.values,a=s.nodeType,r=u.useMemo(()=>qe(s.formData),[s.formData]),i=u.useMemo(()=>X.find(_=>_.type===a),[a]),c=()=>{const _=e.jsx(Re,{...t});if(d===!0)return _;if(typeof d=="function")return(d==null?void 0:d(r))??_};return e.jsxs("div",{className:b.node_layout_wrapper,children:[e.jsx("div",{className:b.tool_bar,children:e.jsx(We,{id:t.id,data:n,formData:r,schemas:i==null?void 0:i.formSchema,editModalWidth:i==null?void 0:i.modalWidth})}),e.jsxs("div",{className:b.node_layout,children:[e.jsx("div",{className:b.node_layout_body,children:o==null?void 0:o(r)}),c()]})]})}const De="_ui_node_ciuuw_1",Ve="_ui_node_header_ciuuw_1",He="_ui_node_body_ciuuw_7",Qe="_ui_node_text_ciuuw_10",N={ui_node:De,ui_node_header:Ve,ui_node_body:He,ui_node_text:Qe},ze=t=>e.jsx(g,{...t,children:n=>e.jsxs("div",{className:N.ui_node,children:[e.jsx("div",{className:N.ui_node_header,children:n.name}),e.jsx("div",{className:N.ui_node_body,children:e.jsx("div",{className:N.ui_node_text,children:n.text})})]})}),Ke="_action_node_14v0w_1",Ye="_action_node_header_14v0w_1",Xe="_action_node_body_14v0w_7",Je="_action_node_text_14v0w_10",v={action_node:Ke,action_node_header:Ye,action_node_body:Xe,action_node_text:Je},Ze=t=>e.jsx(g,{...t,children:n=>e.jsxs("div",{className:v.action_node,children:[e.jsx("div",{className:v.action_node_header,children:"Action Node"}),e.jsxs("div",{className:v.action_node_body,children:[e.jsx("div",{className:v.action_node_text,children:n.type}),e.jsx("div",{className:v.action_node_text,children:n.text})]})]})}),et="_transform_node_1u43d_1",tt="_transform_node_header_1u43d_1",nt="_transform_node_body_1u43d_7",ot="_transform_node_text_1u43d_10",j={transform_node:et,transform_node_header:tt,transform_node_body:nt,transform_node_text:ot},st=t=>e.jsx(g,{...t,children:n=>e.jsxs("div",{className:j.transform_node,children:[e.jsx("div",{className:j.transform_node_header,children:"Transform Node"}),e.jsxs("div",{className:j.transform_node_body,children:[e.jsx("div",{className:j.transform_node_text,children:n.type}),e.jsx("div",{className:j.transform_node_text,children:n.text})]})]})}),dt="_step_node_1riik_1",at="_step_node_header_1riik_1",rt="_step_node_body_1riik_7",it="_step_node_text_1riik_11",ct="_conditions_1riik_19",lt="_condition_handle_1riik_25",y={step_node:dt,step_node_header:at,step_node_body:rt,step_node_text:it,conditions:ct,condition_handle:lt},_t=t=>{const{conditions:n=[],isConnectable:o}=t,{connectionEnable:d=!0,connectionTypes:s=Object.keys(E)}=t.data,a=s.includes("target"),r=s.includes("source");return e.jsxs(u.Fragment,{children:[d&&a&&e.jsx("div",{className:"flow_handle_left",children:e.jsx(C,{type:"target",position:S.Left,className:"flow_handle",isConnectable:o})}),d&&r&&e.jsx("div",{className:y.conditions,children:n.map((i,c)=>e.jsxs("div",{className:y.condition_handle,children:[e.jsx("span",{children:i.condition}),e.jsxs("div",{className:"flow_handle_right",children:[e.jsx(C,{type:"source",id:i.condition,position:S.Right,className:"flow_handle",isConnectable:o}),e.jsx(W,{})]})]},`key_${i.condition}_${c}`))})]})},G=t=>e.jsx(g,{...t,handler:n=>{const o=n.conditions;if(o!=null&&o.length)return e.jsx(_t,{...t,conditions:n.conditions})},children:n=>e.jsxs("div",{className:y.step_node,children:[e.jsx("div",{className:y.step_node_header,children:n.name}),e.jsx("div",{className:y.step_node_body,children:e.jsx("div",{className:y.step_node_text,children:n.text||n.description})})]})}),ut="_prompt_node_syq2g_1",mt="_prompt_node_header_syq2g_1",pt="_prompt_node_body_syq2g_7",ht="_prompt_node_text_syq2g_10",w={prompt_node:ut,prompt_node_header:mt,prompt_node_body:pt,prompt_node_text:ht},xt={text:"Text",prompt:"Prompt"},yt=t=>e.jsx(g,{...t,children:n=>e.jsxs("div",{className:w.prompt_node,children:[e.jsxs("div",{className:w.prompt_node_header,children:[xt[n.type]," Node"]}),e.jsx("div",{className:w.prompt_node_body,children:e.jsx("div",{className:w.prompt_node_text,children:n.text||n.prompt})})]})}),ft={ui:ze,action:Ze,transform:st,step:G,branch:G,prompt:yt},vt=t=>{const{fromX:n,fromY:o,toX:d,toY:s}=t;return e.jsxs("g",{children:[e.jsx("path",{fill:"none",stroke:"#0143EC",strokeWidth:2,className:"animated",d:`M${n},${o} C ${n} ${s} ${n} ${s} ${d},${s}`}),e.jsx("circle",{cx:d,cy:s,fill:"#fff",r:3,stroke:"#0143EC",strokeWidth:2})]})},jt="_nodes_10bm7_1",gt="_node_item_10bm7_4",bt="_node_item_body_10bm7_14",Nt="_node_icon_10bm7_17",wt="_node_title_10bm7_22",Tt="_node_desc_10bm7_27",x={nodes:jt,node_item:gt,node_item_body:bt,node_icon:Nt,node_title:wt,node_desc:Tt},Ct=t=>{const{onNodeClick:n}=t,{role:o}=B(),d=u.useMemo(()=>X.filter(s=>o==="parent"?s.type==="step":s.type!=="step"),[o]);return e.jsx("div",{className:x.nodes,children:d.map(s=>{const a=re[s.icon];return e.jsx(k,{title:`Add ${s.title} Node`,width:s.modalWidth,destroyOnHidden:!0,okText:"Add Node",trigger:e.jsxs("div",{className:x.node_item,children:[e.jsx("div",{className:x.node_icon,children:e.jsx(a,{})}),e.jsxs("div",{className:x.node_item_body,children:[e.jsx("div",{className:x.node_title,children:s.title}),e.jsx("div",{className:x.node_desc,children:s.desc})]})]}),children:e.jsx(Y,{schemas:s.formSchema,onSubmit:async r=>{const i=s.type;n==null||n({...r,nodeType:i})}})},s.type)})})},St=t=>{const{open:n,trigger:o,onClose:d}=je(t.trigger),s=m(a=>{var r;d(),(r=t.onChange)==null||r.call(t,a)});return e.jsxs(u.Fragment,{children:[e.jsx(ie,{open:n,width:400,destroyOnHidden:!0,title:t.title,onClose:d,rootClassName:"shopify",children:e.jsx(Ct,{onNodeClick:s})}),o]})},kt="_add_btn_z3xq6_1",Et={add_btn:kt},Pt=()=>{const{insertNodes:t}=B(),n=m(o=>{const{nodeType:d}=o,s=`${d}_${ce()}`;t([{id:s,type:d,data:{values:o},position:{x:0,y:0}}])});return e.jsx(St,{title:"What triggers this workflow?",onChange:n,trigger:e.jsx("div",{className:Et.add_btn,children:e.jsx(W,{})})})},Ft=u.forwardRef((t,n)=>{const{role:o="parent",initialNodes:d=[],initialEdges:s=[]}=t,[a,r,i]=le(d),[c,_,P]=_e(s),F=m(l=>{for(const p of l){if(a.length){const h=a.map(M=>M.position.x);p.position.x=Math.max(...h)+280}else{const h=p.data;h.connectionTypes||(h.connectionTypes=["source"])}a.push(p)}r([...a])}),q=m((l,p)=>{const h=a.findIndex(M=>M.id===l);h>-1&&(a[h].data=p,r(O(a)))}),$=m(l=>{const p=a.findIndex(h=>h.id===l);p>-1&&(a.splice(p,1),r([...a]))}),I=m(l=>{_(p=>ue(l,p).map(h=>({...h,...Ee})))});return u.useImperativeHandle(n,()=>({getData:()=>O({nodes:a,edges:c})})),e.jsx(Q.Provider,{value:{role:o,insertNodes:F,deleteNode:$,updateNodeData:q},children:e.jsx("div",{className:"ai_work_flow",children:e.jsx(me,{children:e.jsxs(pe,{fitView:!0,nodes:a,edges:c,minZoom:.5,nodeTypes:ft,onConnect:I,onNodesChange:i,onEdgesChange:P,connectionLineComponent:vt,children:[e.jsx(he,{size:2,color:"#ccc",bgColor:"#f6f6f6"}),e.jsx(Pt,{}),e.jsx(xe,{})]})})})})});export{Ft as default};
