import{p as X,q as J,b as m,A as G,u,j as e,m as Z,g as ee,s as te,t as U,v as D,w as ne,x as oe,S as se,y as ae,z as de,o as re,D as ie,H as S,F as k,G as W,J as ce,K as le,L as _e,O as ue,Q as me,U as pe,V as he,W as xe,X as ye,Y as fe}from"./libs-DVEar9x9.js";import{b as B,c as ve,S as je,T as E,u as V,a as ge,d as Ne}from"./index-XY1LvbJg.js";import"./index-DzOoY3lL.js";var be=J();const O=X(be),H=m.createContext({}),R=()=>m.useContext(H),we="_edit_step_modal_1lllx_1",Te="_edit_step_1lllx_1",Ce="_flow_work_1lllx_16",M={edit_step_modal:we,edit_step:Te,flow_work:Ce},Se=t=>{const{message:n}=G.useApp(),[o]=B(),{modal:a}=G.useApp(),s=m.useRef(null),d=u(()=>s.current.getData()),r=u(()=>{var _;const c=d();if(!c.edges.length){n.error("The current flowchart is not completed.");return}(_=t.onSave)==null||_.call(t,c),o()}),i=u(()=>{a.confirm({rootClassName:"shopify",title:"Are you sure you want to leave?",content:"The data on this page will be lost after leaving.",okButtonProps:{className:"shopify"},cancelButtonProps:{className:"shopify"},okText:"Yes",onOk:()=>o()})});return ve(async()=>Promise.reject()),e.jsx(Z,{title:t.title,onBack:i,extra:[e.jsx(je,{type:"primary",onClick:r,children:"Save"})],children:e.jsx("div",{className:M.edit_step,children:e.jsx(ee,{className:"shopify",children:e.jsx("div",{className:M.flow_work,children:e.jsx(Ft,{role:"child",ref:s,initialEdges:t.edges,initialNodes:t.nodes})})})})})},ke=t=>{const{trigger:n,modal:o,...a}=t;return e.jsx(E,{centered:!0,modal:o,width:"100vw",closable:!1,hasFooter:!1,trigger:n,className:M.edit_step_modal,children:e.jsx(Se,{...a})})},Ee={style:{stroke:"#0143EC",strokeWidth:2},markerEnd:{color:"#0143EC",type:te.ArrowClosed}},P={target:"Target",source:"Source"},Pe=[{title:"Connection setting",valueType:"group",columns:[{title:"Enable",valueType:"switch",initialValue:!0,dataIndex:"connectionEnable"},{valueType:"dependency",name:["connectionEnable"],columns:({connectionEnable:t})=>{const n=[];return t&&n.push({title:"Types",valueType:"select",valueEnum:P,dataIndex:"connectionTypes",fieldProps:{mode:"multiple"},initialValue:Object.keys(P)}),n}}]}],Fe=t=>{const[n]=U.useForm(),[o]=B();return V(async()=>{var s;const a=await n.validateFields();(s=t.onSave)==null||s.call(t,a),o()}),e.jsx("div",{style:{padding:"24px 0 0 0"},children:e.jsx(D,{form:n,layout:"horizontal",columns:Pe,submitter:!1,initialValues:t.formData})})},A=t=>{const n=t.valueType,o=t.dependencys||[],a={valueType:n,width:t.width,title:t.title,tooltip:t.tooltip,dataIndex:t.name,valueEnum:t.valueEnum,fieldProps:t.fieldProps,initialValue:t.initialValue,formItemProps:{rules:t.rules}};return t.columns&&(a.columns=t.columns.map(A)),o.length&&(a.valueType="dependency",a.name=o.map(s=>s.name),a.columns=s=>o.filter(({name:r,values:i=[]})=>i.find(c=>c===s[r])).reduce((r,i)=>{const c=i.renders||[];return[...r,...c.map(A)]},[])),a},Q=(t,n={})=>(t.forEach(o=>{var a;o.valueEnum&&(n=Object.assign(n,o.valueEnum)),(a=o.dependencys)==null||a.forEach(s=>{Q(s.renders,n)})}),n),z=(t,n=[])=>(t.forEach(o=>{const a=o.dependencys||[],s=o.valueType||"text";a.length?a.forEach(d=>{z(d.renders,n)}):n.push({type:s,name:o.name})}),n),qe=(t={})=>(t=O(t),Object.keys(t).reduce((n,o)=>({...n,[o]:t[o].value}),{})),$e=(t,n,o)=>(Object.keys(t).map(a=>{const s=n.find(c=>c.name===a),d=t[a],r=(s==null?void 0:s.type)||"text",i={_type_:r,value:d};r==="select"&&(i.label=o[d]),t[a]=i}),t),Ie="_dynamic_form_1eu5x_1",Oe={dynamic_form:Ie},K=t=>{const{schemas:n=[],formData:o}=t,[a]=U.useForm(),[s]=B(),d=m.useMemo(()=>n.map(A),[n]),r=m.useMemo(()=>Q(n),[n]),i=m.useMemo(()=>z(n),[n]);return V(async()=>{var _;let c=await a.validateFields();c=$e(c,i,r),await((_=t.onSubmit)==null?void 0:_.call(t,{formData:c})),s()}),e.jsx("div",{className:Oe.dynamic_form,children:e.jsx(D,{form:a,submitter:!1,columns:d,initialValues:o})})},Me="_tool_bar_container_122m1_1",Ae="_tool_bar_action_122m1_5",v={tool_bar_container:Me,tool_bar_action:Ae},We=t=>{var p;const{data:n}=t,o=n.values,{nodeType:a,formData:s,autoOpenStepCanvas:d=!0}=o,{role:r,deleteNode:i,updateNodeData:c}=R(),[_]=ge(),x=u(async l=>{c(t.id,Object.assign(n,l))}),F=u(async l=>{n.values=Object.assign(n.values,l),x(n)}),q=u(async l=>{x(l)}),$=u(l=>{n.values.stepRealData=l,x(n)}),I=u(()=>{r==="parent"&&a==="step"&&d&&(o.autoOpenStepCanvas=!1,requestAnimationFrame(()=>{_.openModal(),x(n)}))}),h=ne("ai-node-tool-bar",v.tool_bar_container);return oe(I),e.jsx("div",{className:h,children:e.jsxs(se,{size:12,children:[e.jsx("div",{className:v.tool_bar_action,onClick:()=>i(t.id),children:e.jsx(ae,{})}),r==="parent"&&e.jsx(ke,{...o.stepRealData,modal:_,title:(p=s.name)==null?void 0:p.value,onSave:$,trigger:e.jsx("div",{className:v.tool_bar_action,children:e.jsx(de,{})})}),e.jsx(E,{title:"Edit Node",okText:"Save",width:t.editModalWidth,trigger:e.jsx("div",{className:v.tool_bar_action,children:e.jsx(re,{})}),children:e.jsx(K,{...t,onSubmit:F})}),e.jsx(E,{title:"Settings",okText:"Save",trigger:e.jsx("div",{className:v.tool_bar_action,children:e.jsx(ie,{})}),children:e.jsx(Fe,{formData:t.data,onSave:q})})]})})},Be=t=>{const{connectionEnable:n=!0,connectionTypes:o=Object.keys(P)}=t.data,a=o.includes("target"),s=o.includes("source");return e.jsxs(m.Fragment,{children:[n&&a&&e.jsx("div",{className:"flow_handle_left",children:e.jsx(S,{type:"target",position:k.Left,className:"flow_handle",isConnectable:t.isConnectable})}),n&&s&&e.jsxs("div",{className:"flow_handle_right",children:[e.jsx(S,{type:"source",position:k.Right,className:"flow_handle",isConnectable:t.isConnectable}),e.jsx(W,{})]})]})},Y=[{type:"step",icon:"StepForwardOutlined",title:"Step",modalWidth:420,desc:"Execute the corresponding process according to the different branches created.",formSchema:[{title:"Name",name:"name",rules:[{required:!0}]},{title:"Description",name:"description",rules:[{required:!0}]},{name:"conditions",valueType:"formList",fieldProps:{creatorButtonProps:{creatorButtonText:"Add condition"}},columns:[{valueType:"group",columns:[{title:"Condition",name:"condition",fieldProps:{placeholder:"Please enter a condition"},width:"md",rules:[{required:!0}]}]}]}]},{type:"prompt",title:"Prompt",icon:"SendOutlined",modalWidth:"420px",desc:"Prompt the AI what to do or say.",formSchema:[{title:"Type",name:"type",valueType:"radio",valueEnum:{prompt:"Prompt",text:"Text"},initialValue:"prompt",rules:[{required:!0}]},{dependencys:[{name:"type",values:["text"],renders:[{title:"Text",name:"text",rules:[{required:!0}]}]},{name:"type",values:["prompt"],renders:[{title:"Prompt",name:"prompt",rules:[{required:!0}]}]}]}]},{type:"ui",title:"UI",icon:"KubernetesOutlined",desc:"The UI components within the AI assistant can be used as a data source to obtain data.",modalWidth:500,formSchema:[{valueType:"select",title:"Component",name:"name",rules:[{required:!0,message:"Please select Component"}],valueEnum:{UploadFile:"Upload File",GooglePlace:"Google Place",QuestionGroup:"Question Group"}},{dependencys:[{name:"name",values:["UploadFile","GooglePlace","QuestionGroup"],renders:[{title:"Text",name:"text",tooltip:"Description information of the selection component."},{title:"Wait For",name:"waitFor",tooltip:"Wait for the data output by the UI component.",rules:[{required:!0}]}]},{name:"name",values:["UploadFile"],renders:[{title:"Question",name:"question"},{title:"Contact uuid",name:"contactUuid",rules:[{required:!0}]}]},{name:"name",values:["GooglePlace"],renders:[{title:"Keyword",name:"keyword",tooltip:"The default search keywords for Google Place.",rules:[{required:!0}]},{title:"Google Api Key",name:"googleApiKey",rules:[{required:!0}]}]},{name:"name",values:["QuestionGroup"],renders:[{title:"Question Group uuid",name:"questionGroupUuid",rules:[{required:!0}]}]}]}]},{type:"branch",icon:"BranchesOutlined",title:"Branch",modalWidth:420,desc:"Execute the corresponding process according to the different branches created.",formSchema:[{title:"Name",name:"name",rules:[{required:!0}]},{title:"Text",name:"text",rules:[{required:!0}]},{name:"conditions",valueType:"formList",fieldProps:{creatorButtonProps:{creatorButtonText:"Add condition"}},columns:[{valueType:"group",columns:[{title:"Condition",name:"condition",fieldProps:{placeholder:"Please enter a condition"},width:"md",rules:[{required:!0}]}]}]}]},{type:"action",icon:"FunctionOutlined",title:"Action",desc:"Obtain or process data by calling backend interfaces or methods.",formSchema:[{title:"Type",name:"type",rules:[{required:!0}]},{title:"Text",name:"text",rules:[{required:!0}]}]},{type:"transform",icon:"BlockOutlined",title:"Transform",desc:"Convert the input data",formSchema:[{title:"Type",name:"type",rules:[{required:!0}]},{title:"Text",name:"text",rules:[{required:!0}]}]}],Re="_node_layout_wrapper_xpd8g_1",Ge="_tool_bar_xpd8g_13",Le="_node_layout_xpd8g_1",Ue="_node_layout_body_xpd8g_29",w={node_layout_wrapper:Re,tool_bar:Ge,node_layout:Le,node_layout_body:Ue};function N(t){const{data:n,children:o,handler:a=!0}=t,s=n.values,d=s.nodeType,r=m.useMemo(()=>qe(s.formData),[s.formData]),i=m.useMemo(()=>Y.find(_=>_.type===d),[d]),c=()=>{const _=e.jsx(Be,{...t});if(a===!0)return _;if(typeof a=="function")return(a==null?void 0:a(r))??_};return e.jsxs("div",{className:w.node_layout_wrapper,children:[e.jsx("div",{className:w.tool_bar,children:e.jsx(We,{id:t.id,data:n,formData:r,schemas:i==null?void 0:i.formSchema,editModalWidth:i==null?void 0:i.modalWidth})}),e.jsxs("div",{className:w.node_layout,children:[e.jsx("div",{className:w.node_layout_body,children:o==null?void 0:o(r)}),c()]})]})}const De="_ui_node_ciuuw_1",Ve="_ui_node_header_ciuuw_1",He="_ui_node_body_ciuuw_7",Qe="_ui_node_text_ciuuw_10",T={ui_node:De,ui_node_header:Ve,ui_node_body:He,ui_node_text:Qe},ze=t=>e.jsx(N,{...t,children:n=>e.jsxs("div",{className:T.ui_node,children:[e.jsx("div",{className:T.ui_node_header,children:n.name}),e.jsx("div",{className:T.ui_node_body,children:e.jsx("div",{className:T.ui_node_text,children:n.text})})]})}),Ke="_action_node_14v0w_1",Ye="_action_node_header_14v0w_1",Xe="_action_node_body_14v0w_7",Je="_action_node_text_14v0w_10",j={action_node:Ke,action_node_header:Ye,action_node_body:Xe,action_node_text:Je},Ze=t=>e.jsx(N,{...t,children:n=>e.jsxs("div",{className:j.action_node,children:[e.jsx("div",{className:j.action_node_header,children:"Action Node"}),e.jsxs("div",{className:j.action_node_body,children:[e.jsx("div",{className:j.action_node_text,children:n.type}),e.jsx("div",{className:j.action_node_text,children:n.text})]})]})}),et="_transform_node_1u43d_1",tt="_transform_node_header_1u43d_1",nt="_transform_node_body_1u43d_7",ot="_transform_node_text_1u43d_10",g={transform_node:et,transform_node_header:tt,transform_node_body:nt,transform_node_text:ot},st=t=>e.jsx(N,{...t,children:n=>e.jsxs("div",{className:g.transform_node,children:[e.jsx("div",{className:g.transform_node_header,children:"Transform Node"}),e.jsxs("div",{className:g.transform_node_body,children:[e.jsx("div",{className:g.transform_node_text,children:n.type}),e.jsx("div",{className:g.transform_node_text,children:n.text})]})]})}),at="_step_node_1riik_1",dt="_step_node_header_1riik_1",rt="_step_node_body_1riik_7",it="_step_node_text_1riik_11",ct="_conditions_1riik_19",lt="_condition_handle_1riik_25",f={step_node:at,step_node_header:dt,step_node_body:rt,step_node_text:it,conditions:ct,condition_handle:lt},_t=t=>{const{conditions:n=[],isConnectable:o}=t,{connectionEnable:a=!0,connectionTypes:s=Object.keys(P)}=t.data,d=s.includes("target"),r=s.includes("source");return e.jsxs(m.Fragment,{children:[a&&d&&e.jsx("div",{className:"flow_handle_left",children:e.jsx(S,{type:"target",position:k.Left,className:"flow_handle",isConnectable:o})}),a&&r&&e.jsx("div",{className:f.conditions,children:n.map((i,c)=>e.jsxs("div",{className:f.condition_handle,children:[e.jsx("span",{children:i.condition}),e.jsxs("div",{className:"flow_handle_right",children:[e.jsx(S,{type:"source",id:i.condition,position:k.Right,className:"flow_handle",isConnectable:o}),e.jsx(W,{})]})]},`key_${i.condition}_${c}`))})]})},L=t=>e.jsx(N,{...t,handler:n=>{const o=n.conditions;if(o!=null&&o.length)return e.jsx(_t,{...t,conditions:n.conditions})},children:n=>e.jsxs("div",{className:f.step_node,children:[e.jsx("div",{className:f.step_node_header,children:n.name}),e.jsx("div",{className:f.step_node_body,children:e.jsx("div",{className:f.step_node_text,children:n.text||n.description})})]})}),ut="_prompt_node_syq2g_1",mt="_prompt_node_header_syq2g_1",pt="_prompt_node_body_syq2g_7",ht="_prompt_node_text_syq2g_10",C={prompt_node:ut,prompt_node_header:mt,prompt_node_body:pt,prompt_node_text:ht},xt={text:"Text",prompt:"Prompt"},yt=t=>e.jsx(N,{...t,children:n=>e.jsxs("div",{className:C.prompt_node,children:[e.jsxs("div",{className:C.prompt_node_header,children:[xt[n.type]," Node"]}),e.jsx("div",{className:C.prompt_node_body,children:e.jsx("div",{className:C.prompt_node_text,children:n.text||n.prompt})})]})}),ft={ui:ze,action:Ze,transform:st,step:L,branch:L,prompt:yt},vt=t=>{const{fromX:n,fromY:o,toX:a,toY:s}=t;return e.jsxs("g",{children:[e.jsx("path",{fill:"none",stroke:"#0143EC",strokeWidth:2,className:"animated",d:`M${n},${o} C ${n} ${s} ${n} ${s} ${a},${s}`}),e.jsx("circle",{cx:a,cy:s,fill:"#fff",r:3,stroke:"#0143EC",strokeWidth:2})]})},jt="_nodes_1mo0o_1",gt="_node_item_1mo0o_4",Nt="_node_icon_1mo0o_14",bt="_node_item_body_1mo0o_17",wt="_node_title_1mo0o_25",Tt="_node_desc_1mo0o_30",y={nodes:jt,node_item:gt,node_icon:Nt,node_item_body:bt,node_title:wt,node_desc:Tt},Ct=t=>{const{onNodeClick:n}=t,{role:o}=R(),a=m.useMemo(()=>Y.filter(s=>o==="parent"?s.type==="step":s.type!=="step"),[o]);return e.jsx("div",{className:y.nodes,children:a.map(s=>{const d=ce[s.icon];return e.jsx(E,{title:`Add ${s.title} Node`,width:s.modalWidth,destroyOnHidden:!0,okText:"Add Node",trigger:e.jsxs("div",{className:y.node_item,children:[e.jsx("div",{className:y.node_icon,children:e.jsx(d,{})}),e.jsxs("div",{className:y.node_item_body,children:[e.jsx("div",{className:y.node_title,children:s.title}),e.jsx("div",{className:y.node_desc,children:s.desc})]})]}),children:e.jsx(K,{schemas:s.formSchema,onSubmit:async r=>{const i=s.type;n==null||n({...r,nodeType:i})}})},s.type)})})},St=t=>{const{open:n,trigger:o,onClose:a}=Ne(t.trigger),s=u(d=>{var r;a(),(r=t.onChange)==null||r.call(t,d)});return e.jsxs(m.Fragment,{children:[e.jsx(le,{open:n,width:320,destroyOnHidden:!0,title:t.title,onClose:a,rootClassName:"shopify",children:e.jsx(Ct,{onNodeClick:s})}),o]})},kt="_add_btn_z3xq6_1",Et={add_btn:kt},Pt=()=>{const{insertNodes:t}=R(),n=u(o=>{const{nodeType:a}=o,s=`${a}_${_e()}`;t([{id:s,type:a,data:{values:o},position:{x:0,y:0}}])});return e.jsx(St,{title:"What triggers this workflow?",onChange:n,trigger:e.jsx("div",{className:Et.add_btn,children:e.jsx(W,{})})})},Ft=m.forwardRef((t,n)=>{const{role:o="parent",initialNodes:a=[],initialEdges:s=[]}=t,[d,r,i]=ue(a),[c,_,x]=me(s),F=u(h=>{for(const p of h){if(d.length){const l=d.map(b=>b.position.x);p.position.x=Math.max(...l)+280}else{const l=p.data;l.connectionTypes||(l.connectionTypes=["source"])}d.push(p)}r([...d])}),q=u((h,p)=>{const l=d.findIndex(b=>b.id===h);l>-1&&(d[l].data=p,r(O(d)))}),$=u(h=>{const p=d.findIndex(l=>l.id===h);p>-1&&(d.splice(p,1),r([...d]))}),I=u(h=>{_(p=>pe(h,p).map(l=>({...l,...Ee})))});return m.useImperativeHandle(n,()=>({getData:()=>O({nodes:d,edges:c})})),e.jsx(H.Provider,{value:{role:o,insertNodes:F,deleteNode:$,updateNodeData:q},children:e.jsx("div",{className:"ai_work_flow",children:e.jsx(he,{children:e.jsxs(xe,{fitView:!0,nodes:d,edges:c,minZoom:.5,nodeTypes:ft,onConnect:I,onNodesChange:i,onEdgesChange:x,connectionLineComponent:vt,children:[e.jsx(ye,{size:2,color:"#ccc",bgColor:"#f6f6f6"}),e.jsx(Pt,{}),e.jsx(fe,{})]})})})})});export{Ft as default};
