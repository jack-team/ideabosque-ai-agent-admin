import{b as u,u as x,y as K,z as Te,D as Z,o as X,j as t,F as q,S as Ee,G as ke,H as De,J as Pe,K as $e,Q,U as ee,V as H,W as b,p as R,v as A,X as te,Y as We,Z as ne,w as V,f as z,g as C,_ as qe,$ as Re,a0 as Ae,a1 as Me,a2 as Le,a3 as He,a4 as Be,a5 as Ue,a6 as Oe,a7 as se,a8 as Ve,a9 as ze,aa as Ye,ab as Xe,ac as Je,ad as Ge,M as Ke,ae as oe,m as Y,x as Ze,af as Qe,h as et,A as tt,t as nt,ag as st,n as ot}from"./libs-0PvTe91r.js";import{k as rt,j as at}from"./workflow-CFtAOMA8.js";import{c as J}from"./index-DuVnbgUf.js";import{b as ct,u as lt,T as it,c as dt}from"./index-DPy9wtRK.js";import{S as ut}from"./index-Bl_Q_f31.js";import{S as re}from"./index-CendYzG9.js";import{S as mt}from"./index-CNw0qaLN.js";import"./request-DTZC4S0h.js";function ae(e){return[u.useRef(e).current]}function ce(e,n){const s=n(),o=x(()=>{!e||!s||Object.keys(s).forEach(r=>{e[r]=s[r]})});u.useEffect(o,[s,o])}const le=u.createContext({}),ie=u.createContext({}),pt=()=>ae({getData:()=>null}),de=()=>ae({getData:()=>null}),y=()=>u.useContext(le),ue=()=>u.useContext(ie),ht=()=>{const{detailId:e}=y();return Z().find(s=>s.id===e)},xt=()=>{const e=ht();return e==null?void 0:e.data};function v(){var s;const e=K(),n=Te(e);return(s=n==null?void 0:n.data)==null?void 0:s.formData}const _t="_form_svv3s_1",ft={form:_t},gt=e=>{var r;const{onSubmit:n}=e,[s]=ct(),[o]=X.useForm();return lt(async()=>{const c=await(o==null?void 0:o.validateFields());c&&await n(c),s()}),t.jsx(X,{form:o,submitter:!1,className:ft.form,initialValues:e.formData,children:(r=e.children)==null?void 0:r.call(e,o)})},me=e=>{const{children:n,onSubmit:s,formData:o,...r}=e;return t.jsx(it,{...r,children:t.jsx(gt,{formData:o,onSubmit:s,children:n})})},jt="_wrapper_167g9_4",bt="_tools_167g9_4",yt="_tool_item_167g9_15",Nt="_inner_167g9_26",vt="_content_167g9_34",wt="_handle_167g9_38",Ct="_handle_source_167g9_39",Ft="_branch_167g9_59",St="_branch_item_167g9_63",It="_branch_label_167g9_71",g={wrapper:jt,tools:bt,tool_item:yt,inner:Nt,content:vt,handle:wt,handle_source:Ct,branch:Ft,branch_item:St,branch_label:It},Tt=e=>{const{nodeId:n,tools:s}=e,{editForm:o}=s,{top:r}=ue(),{openDetail:c}=y(),{setNodes:a,updateNodeData:l}=q(),i=v(),d=x(()=>{a(m=>m.filter(p=>p.id!==n))}),j=x(async m=>{l(n,{formData:m})}),_=x(()=>{c(n)}),h=m=>o?t.jsx(me,{centered:!0,okText:"Save",destroyOnHidden:!0,trigger:m,formData:i,width:o.width,onSubmit:j,title:o.title||"Edit Node",children:p=>t.jsx(o.Component,{form:p})}):null;return t.jsxs(Ee,{children:[r&&t.jsx("div",{onClick:_,className:g.tool_item,children:t.jsx(ke,{})}),h(t.jsx("div",{className:g.tool_item,children:t.jsx(Pe,{})})),t.jsx("div",{onClick:d,className:g.tool_item,children:t.jsx(De,{})})]})},Et="_atom_node_fh105_1",kt="_atom_icon_fh105_11",Dt="_atom_content_fh105_21",Pt="_atom_title_fh105_24",$t="_atom_desc_fh105_30",I={atom_node:Et,atom_icon:kt,atom_content:Dt,atom_title:Pt,atom_desc:$t},G=e=>{const{Icon:n,...s}=e;return t.jsxs("div",{onClick:e.onClick,className:I.atom_node,children:[t.jsx("div",{className:I.atom_icon,children:t.jsx(n,{})}),t.jsxs("div",{className:I.atom_content,children:[t.jsx("div",{className:I.atom_title,children:s.title}),t.jsx("div",{className:I.atom_desc,children:s.desc})]})]})},Wt=e=>{const{triggerId:n,onChange:s,closeDrawer:o}=e,r=Z(),{top:c}=ue();return t.jsx(u.Fragment,{children:Ne.filter(a=>c?a.top:a.top?!1:a.limit!==void 0?r.filter(i=>i.type===a.type).length<a.limit:!0).map(a=>{const{type:l,Component:i,...d}=a,j=i.Icon,_=i.Form,h=async(m={})=>{o(),s==null||s({nodeType:l,triggerId:n,formData:m})};return _?t.jsx(me,{centered:!0,okText:"Add Node",onSubmit:h,width:i.modalWdith,title:`Add ${d.title} Node`,children:m=>t.jsx(_,{form:m}),trigger:t.jsx(G,{...d,Icon:j})},l):u.createElement(G,{...d,Icon:j,key:l,onClick:h})})})},qt=e=>{const{children:n,...s}=e,{open:o,trigger:r,onClose:c}=dt(n);return t.jsxs(t.Fragment,{children:[r,t.jsx($e,{open:o,destroyOnHidden:!0,onClose:c,rootClassName:"shopify",title:"What triggers this workflow?",children:t.jsx(Wt,{...s,closeDrawer:c})})]})},pe="default_source_handle",B="default_target_handle",U="start-id",Rt={id:U,type:"start",data:{formData:{}},position:{x:0,y:0}},At=e=>{const{branch:n=[]}=e,s=o=>t.jsx(qt,{triggerId:o,onChange:e.onChange,children:t.jsx(Q,{id:o,type:"source",position:ee.Right,className:g.handle_source})});return n.length?t.jsx("div",{className:g.branch,children:n.map(o=>t.jsxs("div",{className:g.branch_item,children:[t.jsx("div",{className:g.branch_label,children:o.label}),s(o.value)]},o.value))}):s(pe)},w=e=>{const{tools:n,branch:s=[],enableHandle:o}=e,{source:r=!0,target:c=!0}=o||{},a=K(),{openDetail:l}=y(),{addEdges:i,addNodes:d,getNodes:j}=q(),_=x(()=>{var W;const p=j().find(Ie=>Ie.id===a);let f=(p==null?void 0:p.position.x)||0;const S=(p==null?void 0:p.position.y)||0;return f=f+(((W=p==null?void 0:p.measured)==null?void 0:W.width)||0)+80,{x:f,y:S}}),h=x(m=>{const p=m.triggerId,f=H();d({id:f,data:m,type:m.nodeType,position:_()}),i({id:H(),source:a,target:f,sourceHandle:p,targetHandle:B}),m.nodeType==="step"&&l(f)});return t.jsxs("div",{className:g.wrapper,children:[t.jsx("div",{className:g.tools,children:!!n&&t.jsx(Tt,{nodeId:a,tools:n})}),t.jsxs("div",{className:g.inner,children:[c&&t.jsx(Q,{type:"target",id:B,position:ee.Left,className:g.handle,isConnectableStart:!1}),t.jsx("div",{className:g.content,children:e.children}),r&&t.jsx(At,{branch:s,onChange:h})]})]})},Mt="_title_1tfkx_1",Lt="_description_1tfkx_6",M={title:Mt,description:Lt},F=e=>t.jsxs("div",{className:M.node_desc,children:[t.jsx("div",{className:M.title,children:e.title}),t.jsx("div",{className:M.description,children:e.desc})]}),Ht=e=>{const{inputParams:n=[]}=e;return n.map(s=>{const o=s.options,r={label:s.label,name:s.name,disabled:s.disabled,readonly:s.readonly,initialValue:s.initialValue,rules:[{required:s.required}]};return t.jsx(u.Fragment,{children:o!=null&&o.length?t.jsx(R,{...r,options:o}):t.jsx(b,{...r})},s.name)})},he=()=>{const{uiComponents:e=[]}=y(),n=e.map(s=>({label:s.componentName,value:s.componentTag}));return t.jsxs(u.Fragment,{children:[t.jsx(R,{label:"Component",name:"name",options:n,rules:[{required:!0}]}),t.jsx(A,{label:"Text",name:"text",rules:[{required:!0}]}),t.jsx(te,{name:["name"],children:({name:s})=>{const o=e.find(r=>r.componentTag===s);return t.jsx(Ht,{inputParams:o==null?void 0:o.input})}})]})},T=()=>{const e=v(),{uiComponents:n=[]}=y(),s=n.find(o=>o.componentTag===(e==null?void 0:e.name));return t.jsx(w,{tools:{editForm:{Component:he,title:"Edit Ui node",width:T.modalWdith}},children:t.jsx(F,{title:s==null?void 0:s.componentName,desc:e==null?void 0:e.text})})};T.Form=he;T.modalWdith=400;T.Icon=We;const Bt="_container_12b9h_1",Ut="_icon_12b9h_7",Ot="_text_12b9h_12",L={container:Bt,icon:Ut,text:Ot},xe=()=>t.jsx(w,{enableHandle:{target:!1},children:t.jsxs("div",{className:L.container,children:[t.jsx("div",{className:L.icon,children:t.jsx(ne,{})}),t.jsx("div",{className:L.text,children:"Start"})]})});xe.Icon=ne;const _e=()=>t.jsxs(u.Fragment,{children:[t.jsx(b,{name:"name",label:"Name",rules:[{required:!0}]}),t.jsx(A,{label:"Text",name:"text",rules:[{required:!1}]}),t.jsx(V,{label:"Condition",name:"branch",children:t.jsxs(z,{gutter:16,children:[t.jsx(C,{span:12,children:t.jsx(b,{label:"Label",name:"label",rules:[{required:!0}]})}),t.jsx(C,{span:12,children:t.jsx(b,{label:"Value",name:"value",rules:[{required:!0}]})})]})})]}),E=()=>{const e=v();return t.jsx(w,{branch:e==null?void 0:e.branch,tools:{editForm:{width:E.modalWdith,title:"Edit Branch node",Component:_e}},children:t.jsx(F,{title:e==null?void 0:e.name,desc:e==null?void 0:e.text})})};E.Form=_e;E.modalWdith=400;E.Icon=qe;var fe=(e=>(e.Prompt="prompt",e.Text="text",e))(fe||{});const O={prompt:"Prompt",text:"Text"},ge=()=>t.jsxs(u.Fragment,{children:[t.jsx(Re.Group,{label:"Type",name:"type",initialValue:fe.Prompt,valueEnum:O,rules:[{required:!0}]}),t.jsx(te,{name:["type"],children:({type:e})=>e?t.jsx(b,{label:O[e],name:"text",rules:[{required:!0}]}):null})]}),k=()=>{const e=v(),n=e==null?void 0:e.type;return t.jsx(w,{tools:{editForm:{width:k.modalWdith,title:"Edit Prompt node",Component:ge}},children:t.jsx(F,{title:n&&O[n],desc:e==null?void 0:e.text})})};k.Form=ge;k.modalWdith=360;k.Icon=Ae;const je=()=>{const{actions:e=[]}=y(),n=u.useMemo(()=>e.map(s=>({value:s.name,label:s.description})),[e]);return t.jsxs(u.Fragment,{children:[t.jsx(R,{label:"Action",name:"type",options:n,rules:[{required:!0}]}),t.jsx(A,{label:"Text",name:"text",rules:[{required:!1}]})]})},D=()=>{const{actions:e=[]}=y(),n=v(),s=u.useMemo(()=>e.find(o=>(n==null?void 0:n.type)===o.name),[e,n==null?void 0:n.type]);return t.jsx(w,{tools:{editForm:{Component:je,title:"Edit Action node",width:D.modalWdith}},children:t.jsx(F,{title:s==null?void 0:s.name,desc:n==null?void 0:n.text})})};D.Form=je;D.modalWdith=400;D.Icon=Me;const be=()=>{const{transformTools:e=[]}=y();return t.jsxs(u.Fragment,{children:[t.jsx(R,{options:e,label:"Type",name:"type",rules:[{required:!0}]}),t.jsx(b,{label:"Text",name:"text",rules:[{required:!0}]}),t.jsx(V,{name:"attrs",label:"Attributes",creatorButtonProps:{creatorButtonText:"Add Attribute"},children:t.jsxs(z,{gutter:16,children:[t.jsx(C,{span:12,children:t.jsx(b,{label:"From",name:"from",rules:[{required:!0}]})}),t.jsx(C,{span:12,children:t.jsx(b,{label:"To",name:"to",rules:[{required:!0}]})})]})})]})},P=()=>{const{transformTools:e=[]}=y(),n=v(),s=u.useMemo(()=>e.find(o=>o.value===(n==null?void 0:n.type)),[e,n==null?void 0:n.type]);return t.jsx(w,{tools:{editForm:{width:P.modalWdith,title:"Edit Transform node",Component:be}},children:t.jsx(F,{title:s==null?void 0:s.label,desc:n==null?void 0:n.text})})};P.Form=be;P.modalWdith=450;P.Icon=Le;const ye=()=>t.jsxs(u.Fragment,{children:[t.jsx(b,{label:"Name",name:"name",rules:[{required:!0}]}),t.jsx(A,{label:"Description",name:"description",rules:[{required:!1}]}),t.jsx(V,{label:"Condition",name:"branch",children:t.jsxs(z,{gutter:16,children:[t.jsx(C,{span:12,children:t.jsx(b,{label:"Label",name:"label",rules:[{required:!0}]})}),t.jsx(C,{span:12,children:t.jsx(b,{label:"Value",name:"value",rules:[{required:!0}]})})]})})]}),$=()=>{const e=v();return t.jsx(w,{branch:e==null?void 0:e.branch,tools:{editForm:{Component:ye,title:"Edit Step node",width:$.modalWdith}},children:t.jsx(F,{title:e==null?void 0:e.name,desc:e==null?void 0:e.description})})};$.Form=ye;$.modalWdith=380;$.Icon=He;const Ne=[{top:!0,type:"step",title:"Step",desc:"Execute the corresponding process according to the different branches created.",Component:$},{limit:1,type:"start",title:"Start",desc:"The starting node of a workflow.",Component:xe},{type:"ui",title:"UI",desc:"The UI components within the AI assistant can be used as a data source to obtain data.",Component:T},{type:"branch",title:"Branch",desc:"Execute the corresponding process according to the different branches created.",Component:E},{type:"prompt",title:"Prompt",desc:"Prompt the AI what to do or say.",Component:k},{type:"action",title:"Action",desc:"Execute the corresponding process according to the different branches created.",Component:D},{type:"transform",title:"Transform",desc:"Convert the input data.",Component:P}],Vt=e=>{const{stroke:n}=e;return t.jsx("defs",{children:t.jsx("marker",{id:e.id,refX:"0",refY:"0",markerWidth:"12.5",markerHeight:"12.5",viewBox:"-10 -10 20 20",markerUnits:"strokeWidth",orient:"auto-start-reverse",style:{stroke:n,fill:n,strokeWidth:1},children:t.jsx("polyline",{strokeLinecap:"round",strokeLinejoin:"round",points:"-5,-4 0,0 -5,4 -5,-4"})})})},zt="_del_btn_7471i_1",Yt={del_btn:zt},Xt=e=>{const{id:n,selected:s,sourceX:o,sourceY:r,targetX:c,targetY:a,sourcePosition:l,targetPosition:i}=e,{setEdges:d}=q(),[j,_,h]=Be({sourceX:o,sourceY:r,targetX:c,targetY:a}),m=u.useMemo(()=>`translate(-50%, -50%) 
      translate(${_}px,${h}px)`,[_,h]),p=s?"#f40":"#0143EC",f=x(()=>{d(S=>S.filter(W=>W.id!==n))});return t.jsxs(u.Fragment,{children:[t.jsx(Vt,{stroke:p,id:n}),t.jsx(Ue,{sourceX:o,sourceY:r,targetX:c,targetY:a,markerEnd:`url(#${n})`,sourcePosition:l,targetPosition:i,style:{stroke:p,strokeWidth:2}}),t.jsx(Oe,{children:s?t.jsx("div",{style:{transform:m},onClick:f,className:Yt.del_btn,children:t.jsx(se,{})}):null})]})},Jt={"step-edge":Xt},Gt=Ne.reduce((e,n)=>({...e,[n.type]:n.Component}),{}),ve=e=>{const{canvas:n,top:s=!0,defaultNodes:o=[],defaultEdges:r=[]}=e,c=u.useMemo(()=>o.length?o:[J(Rt)],[o]),[a,l,i]=Ve(r),[d,j,_]=ze(c),h=a.map(f=>({...f,type:"step-edge"})),m=x(f=>l(S=>Ye(f,S))),p=x(()=>J({edges:a,nodes:d,_v_:1}));return ce(n,()=>({getData:p})),t.jsx(ie,{value:{top:s},children:t.jsxs(Xe,{minZoom:.5,nodes:d,edges:h,edgeTypes:Jt,nodeTypes:Gt,deleteKeyCode:null,onConnect:m,onNodesChange:_,onEdgesChange:i,fitView:!0,children:[t.jsx(Je,{size:2,color:"#ccc",bgColor:"#f6f6f6"}),t.jsx(Ge,{})]})})},Kt="_detail_1hmmw_1",Zt="_show_1hmmw_14",Qt="_layer_1hmmw_19",en="_layer_content_1hmmw_25",tn="_layer_header_1hmmw_28",nn="_close_btn_1hmmw_33",sn="_title_1hmmw_46",N={detail:Kt,show:Zt,layer:Qt,layer_content:en,layer_header:tn,close_btn:nn,title:sn},on=()=>{var h;const e=xt(),[n]=de(),{updateNodeData:s}=q(),[o,r]=Ke.useModal(),{closeDetail:c,detailId:a}=y(),l=e==null?void 0:e.details,i=l==null?void 0:l.nodes,d=l==null?void 0:l.edges,j=x(()=>{const m=n.getData();s(a,{details:m}),c()}),_=x(()=>{o.confirm({title:"Are you sure you want to leave?",content:"The data on this page will be lost after leaving.",okText:"Yes",okButtonProps:{className:"shopify"},cancelButtonProps:{className:"shopify"},onOk:c})});return t.jsxs("div",{className:N.layer,children:[t.jsxs("div",{className:N.layer_header,children:[t.jsx("div",{onClick:_,className:N.close_btn,children:t.jsx(se,{})}),t.jsx("div",{className:N.title,children:(h=e==null?void 0:e.formData)==null?void 0:h.name}),t.jsx(re,{type:"primary",onClick:j,children:"Save"})]}),t.jsx("div",{className:N.layer_content,children:t.jsx(oe,{children:t.jsx(ve,{top:!1,canvas:n,defaultNodes:i,defaultEdges:d})})}),r]})},rn=()=>{const{detailId:e}=y(),[n,s]=Y(!1),o=x(()=>s(!0)),r=x(()=>s(!1));Ze(()=>{e?o():setTimeout(r,400)},[e]);const c=Qe(N.detail,!!e&&N.show);return t.jsx("div",{className:c,children:n&&t.jsx(on,{})})},an=e=>{const{children:n,...s}=e,[o,r]=Y(),c=x(l=>{r(l)}),a=x(()=>{r(void 0)});return t.jsx(le.Provider,{value:{...s,detailId:o,openDetail:c,closeDetail:a},children:n})},we=e=>{const n=new Map;for(const s of e){const o=s.source,r=n.get(o)||[];n.set(o,[...r,s])}return n},cn=(e,n="")=>({id:H(),source:e,target:n,sourceHandle:pe,targetHandle:B}),ln=e=>{const n=[];for(const s of e){n.push(s);const o=s.target;e.find(r=>r.source===o)||n.push(cn(o))}return n};function dn(e){e=ln(e);const n=e.find(a=>a.source===U);if(!n)return e;const s=we(e),o=[n];let r=n.target;const c=a=>s.get(a)||[];for(;c(r).length;){const[a]=c(r);o.push(a),r=a.target;const l=c(r).filter(i=>i.id!==a.id);s.set(r,l)}for(const a of e)o.some(l=>l.id===a.id)||o.push(a);return o.filter(a=>a.source!==U)}const un=e=>[...we(e)].map(([n,s])=>{const[o]=s,r=o.target,c=s.length>1?s:[],a={id:n},l=c.map(i=>({condition:i.sourceHandle,nextStep:i.target}));return l.length&&(a.conditions=l),c.length||(a.nextStep=r),a});function Ce(e){const n=new Map,s=e.nodes||[],o=e.edges||[];for(const l of s)n.set(l.id,l);const r=dn(o),c=un(r),a=l=>n.get(l);return c.map(l=>{const i=a(l.id),d=i==null?void 0:i.data,{branch:j,..._}={...d==null?void 0:d.formData},h={...l,type:i==null?void 0:i.type,formData:_};return d!=null&&d.details&&(h.details=Ce(d==null?void 0:d.details)),h})}const mn=e=>{const[n]=de(),s=x(()=>{const o=n.getData();return{realDetails:o,assembleData:Ce(o)}});return ce(e.flow,()=>({getData:s})),t.jsx(oe,{children:t.jsxs(an,{...e,children:[t.jsx(ve,{...e,canvas:n}),t.jsx(rn,{})]})})},pn=(e={})=>Object.keys(e).reduce((n,s)=>{var r,c;let o=(r=e[s])==null?void 0:r.value;if(s==="conditions"){s="branch";const a=o;o=(c=a==null?void 0:a.map)==null?void 0:c.call(a,l=>({label:l.condition,value:l.condition}))}return{...n,[s]:o}},{}),Fe=e=>{if(e!=null&&e._v_)return e;let n=(e==null?void 0:e.nodes)||[];return n=n.map(s=>{var r;const o=(r=s==null?void 0:s.data)==null?void 0:r.values;return{...s,data:{nodeType:o==null?void 0:o.nodeType,formData:pn(o==null?void 0:o.formData),details:Fe(o==null?void 0:o.stepRealData)}}}),{...e,nodes:n}},hn=e=>e.map(n=>({componentName:n.tag_name,componentTag:n.tag_name,componentId:n.ui_component_uuid,componentType:n.ui_component_type,input:n.parameters.map(s=>{let o=s.parameter;return o&&(o=`{${o}}`),{required:!0,label:s.name,name:s.name,initialValue:o}})})),xn=e=>e.reduce((s,o)=>[...s,...o.tools],[]).map(s=>({name:s.name,description:s.description})),_n=()=>[{label:"Summarize",value:"summarize"},{label:"Full content",value:"full_content"},{label:"Structure input",value:"structure_input"}],fn="_loading_1cv3a_1",gn="_container_1cv3a_7",Se={loading:fn,container:gn},jn=e=>{const{promptTemplate:n,flowRelationship:s}=e.detail,o=xn(n.mcp_servers),r=_n(),c=hn(n.ui_components),a=u.useMemo(()=>{const l=s?JSON.parse(s):{};return Fe(l)},[s,c]);return t.jsx(et,{className:"shopify full-content",children:t.jsx("div",{className:Se.container,children:t.jsx(mn,{flow:e.flow,actions:o,uiComponents:c,transformTools:r,defaultEdges:a.edges,defaultNodes:a.nodes})})})};function In(){var i;const{message:e}=tt.useApp(),[n]=pt(),s=nt(),[o,r]=Y(!1),{data:c}=st(async()=>(await rt({flowSnippetUuid:s.uid,flowSnippetVersionUuid:s.vid})).flowSnippet),a=(i=c==null?void 0:c.promptTemplate)==null?void 0:i.prompt_uuid,l=x(async()=>{const d=n.getData();r(!0),await at({...c,promptUuid:a,flowContext:JSON.stringify(d.assembleData),flowRelationship:JSON.stringify(d.realDetails)}),e.success("Workflow saved successfully"),r(!1)});return t.jsx(ot,{title:c==null?void 0:c.flowName,className:"shopify full-screen",loading:!c&&t.jsx("div",{className:Se.loading,children:t.jsx(ut,{size:36})}),extra:c?t.jsx(re,{type:"primary",className:"shopify",onClick:l,children:"Save"}):null,children:t.jsx(mt,{loading:o,children:!!c&&t.jsx(jn,{flow:n,detail:c})})})}export{In as default};
