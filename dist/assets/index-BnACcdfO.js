import{p as X,q as Z,b as m,A as R,u,j as e,m as J,g as ee,s as te,t as U,v as D,w as ne,x as oe,S as se,y as ae,z as de,o as re,D as ie,H as S,F as k,G as A,J as ce,K as le,Q as _e,U as ue,V as me,W as pe,X as he,Y as xe,Z as ye,_ as fe}from"./libs-qDg_pKW0.js";import{b as W,c as ve,S as je,T as E,u as L,a as ge,d as Ne}from"./index-CCESNsZa.js";import"./index-Blz_3hBI.js";var be=Z();const M=X(be),V=m.createContext({}),B=()=>m.useContext(V),we="_edit_step_modal_v2k9j_1",Te="_flow_work_v2k9j_16",H={edit_step_modal:we,flow_work:Te},Ce=t=>{const{message:n}=R.useApp(),[o]=W(),{modal:a}=R.useApp(),s=m.useRef(null),d=u(()=>s.current.getData()),r=u(()=>{var _;const c=d();if(!c.edges.length){n.error("The current flowchart is not completed.");return}(_=t.onSave)==null||_.call(t,c),o()}),i=u(()=>{a.confirm({rootClassName:"shopify",title:"Are you sure you want to leave?",content:"The data on this page will be lost after leaving.",okButtonProps:{className:"shopify"},cancelButtonProps:{className:"shopify"},okText:"Yes",onOk:()=>o()})});return ve(async()=>Promise.reject()),e.jsx(J,{title:t.title,onBack:i,className:"shopify full-screen",extra:[e.jsx(je,{type:"primary",onClick:r,children:"Save"})],children:e.jsx(ee,{className:"shopify full-content",children:e.jsx("div",{className:H.flow_work,children:e.jsx(Pt,{role:"child",ref:s,initialEdges:t.edges,initialNodes:t.nodes})})})})},Se=t=>{const{trigger:n,modal:o,...a}=t;return e.jsx(E,{centered:!0,modal:o,width:"100vw",closable:!1,hasFooter:!1,trigger:n,className:H.edit_step_modal,children:e.jsx(Ce,{...a})})},ke={style:{stroke:"#0143EC",strokeWidth:2},markerEnd:{color:"#0143EC",type:te.ArrowClosed}},P={target:"Target",source:"Source"},Ee=[{title:"Connection setting",valueType:"group",columns:[{title:"Enable",valueType:"switch",initialValue:!0,dataIndex:"connectionEnable"},{valueType:"dependency",name:["connectionEnable"],columns:({connectionEnable:t})=>{const n=[];return t&&n.push({title:"Types",valueType:"select",valueEnum:P,dataIndex:"connectionTypes",fieldProps:{mode:"multiple"},initialValue:Object.keys(P)}),n}}]}],Pe=t=>{const[n]=U.useForm(),[o]=W();return L(async()=>{var s;const a=await n.validateFields();(s=t.onSave)==null||s.call(t,a),o()}),e.jsx("div",{style:{padding:"24px 0 0 0"},children:e.jsx(D,{form:n,layout:"horizontal",columns:Ee,submitter:!1,initialValues:t.formData})})},O=t=>{const n=t.valueType,o=t.dependencys||[],a={valueType:n,width:t.width,title:t.title,tooltip:t.tooltip,dataIndex:t.name,valueEnum:t.valueEnum,fieldProps:t.fieldProps,initialValue:t.initialValue,formItemProps:{rules:t.rules}};return t.columns&&(a.columns=t.columns.map(O)),o.length&&(a.valueType="dependency",a.name=o.map(s=>s.name),a.columns=s=>o.filter(({name:r,values:i=[]})=>i.find(c=>c===s[r])).reduce((r,i)=>{const c=i.renders||[];return[...r,...c.map(O)]},[])),a},Q=(t,n={})=>(t.forEach(o=>{var a;o.valueEnum&&(n=Object.assign(n,o.valueEnum)),(a=o.dependencys)==null||a.forEach(s=>{Q(s.renders,n)})}),n),z=(t,n=[])=>(t.forEach(o=>{const a=o.dependencys||[],s=o.valueType||"text";a.length?a.forEach(d=>{z(d.renders,n)}):n.push({type:s,name:o.name})}),n),Fe=(t={})=>(t=M(t),Object.keys(t).reduce((n,o)=>({...n,[o]:t[o].value}),{})),qe=(t,n,o)=>(Object.keys(t).map(a=>{const s=n.find(c=>c.name===a),d=t[a],r=(s==null?void 0:s.type)||"text",i={_type_:r,value:d};r==="select"&&(i.label=o[d]),t[a]=i}),t),$e="_dynamic_form_1eu5x_1",Ie={dynamic_form:$e},K=t=>{const{schemas:n=[],formData:o}=t,[a]=U.useForm(),[s]=W(),d=m.useMemo(()=>n.map(O),[n]),r=m.useMemo(()=>Q(n),[n]),i=m.useMemo(()=>z(n),[n]);return L(async()=>{var _;let c=await a.validateFields();c=qe(c,i,r),await((_=t.onSubmit)==null?void 0:_.call(t,{formData:c})),s()}),e.jsx("div",{className:Ie.dynamic_form,children:e.jsx(D,{form:a,submitter:!1,columns:d,initialValues:o})})},Me="_tool_bar_container_122m1_1",Oe="_tool_bar_action_122m1_5",v={tool_bar_container:Me,tool_bar_action:Oe},Ae=t=>{var p;const{data:n}=t,o=n.values,{nodeType:a,formData:s,autoOpenStepCanvas:d=!0}=o,{role:r,deleteNode:i,updateNodeData:c}=B(),[_]=ge(),x=u(async l=>{c(t.id,Object.assign(n,l))}),F=u(async l=>{n.values=Object.assign(n.values,l),x(n)}),q=u(async l=>{x(l)}),$=u(l=>{n.values.stepRealData=l,x(n)}),I=u(()=>{r==="parent"&&a==="step"&&d&&(o.autoOpenStepCanvas=!1,requestAnimationFrame(()=>{_.openModal(),x(n)}))}),h=ne("ai-node-tool-bar",v.tool_bar_container);return oe(I),e.jsx("div",{className:h,children:e.jsxs(se,{size:12,children:[e.jsx("div",{className:v.tool_bar_action,onClick:()=>i(t.id),children:e.jsx(ae,{})}),r==="parent"&&e.jsx(Se,{...o.stepRealData,modal:_,title:(p=s.name)==null?void 0:p.value,onSave:$,trigger:e.jsx("div",{className:v.tool_bar_action,children:e.jsx(de,{})})}),e.jsx(E,{title:"Edit Node",okText:"Save",width:t.editModalWidth,trigger:e.jsx("div",{className:v.tool_bar_action,children:e.jsx(re,{})}),children:e.jsx(K,{...t,onSubmit:F})}),e.jsx(E,{title:"Settings",okText:"Save",trigger:e.jsx("div",{className:v.tool_bar_action,children:e.jsx(ie,{})}),children:e.jsx(Pe,{formData:t.data,onSave:q})})]})})},We=t=>{const{connectionEnable:n=!0,connectionTypes:o=Object.keys(P)}=t.data,a=o.includes("target"),s=o.includes("source");return e.jsxs(m.Fragment,{children:[n&&a&&e.jsx("div",{className:"flow_handle_left",children:e.jsx(S,{type:"target",position:k.Left,className:"flow_handle",isConnectable:t.isConnectable})}),n&&s&&e.jsxs("div",{className:"flow_handle_right",children:[e.jsx(S,{type:"source",position:k.Right,className:"flow_handle",isConnectable:t.isConnectable}),e.jsx(A,{})]})]})},Y=[{type:"step",icon:"StepForwardOutlined",title:"Step",modalWidth:420,desc:"Execute the corresponding process according to the different branches created.",formSchema:[{title:"Name",name:"name",rules:[{required:!0}]},{title:"Description",name:"description",rules:[{required:!0}]},{name:"conditions",valueType:"formList",fieldProps:{creatorButtonProps:{creatorButtonText:"Add condition"}},columns:[{valueType:"group",columns:[{title:"Condition",name:"condition",fieldProps:{placeholder:"Please enter a condition"},width:"md",rules:[{required:!0}]}]}]}]},{type:"prompt",title:"Prompt",icon:"SendOutlined",modalWidth:420,desc:"Prompt the AI what to do or say.",formSchema:[{title:"Type",name:"type",valueType:"radio",valueEnum:{prompt:"Prompt",text:"Text"},initialValue:"prompt",rules:[{required:!0}]},{dependencys:[{name:"type",values:["text"],renders:[{title:"Text",name:"text",rules:[{required:!0}]}]},{name:"type",values:["prompt"],renders:[{title:"Prompt",name:"prompt",rules:[{required:!0}]}]}]}]},{type:"ui",title:"UI",icon:"KubernetesOutlined",desc:"The UI components within the AI assistant can be used as a data source to obtain data.",modalWidth:420,formSchema:[{valueType:"select",title:"Component",name:"name",rules:[{required:!0,message:"Please select Component"}],valueEnum:{UploadFile:"Upload File",GooglePlace:"Google Place",QuestionGroup:"Question Group"}},{dependencys:[{name:"name",values:["UploadFile","GooglePlace","QuestionGroup"],renders:[{title:"Text",name:"text",tooltip:"Description information of the selection component."},{title:"Wait For",name:"waitFor",tooltip:"Wait for the data output by the UI component.",rules:[{required:!0}]}]},{name:"name",values:["UploadFile"],renders:[{title:"Question",name:"question"},{title:"Contact uuid",name:"contactUuid",rules:[{required:!0}]}]},{name:"name",values:["GooglePlace"],renders:[{title:"Keyword",name:"keyword",tooltip:"The default search keywords for Google Place.",rules:[{required:!0}]},{title:"Google Api Key",name:"googleApiKey",rules:[{required:!0}]}]},{name:"name",values:["QuestionGroup"],renders:[{title:"Question Group uuid",name:"questionGroupUuid",rules:[{required:!0}]}]}]}]},{type:"branch",icon:"BranchesOutlined",title:"Branch",modalWidth:420,desc:"Execute the corresponding process according to the different branches created.",formSchema:[{title:"Name",name:"name",rules:[{required:!0}]},{title:"Text",name:"text",rules:[{required:!0}]},{name:"conditions",valueType:"formList",fieldProps:{creatorButtonProps:{creatorButtonText:"Add condition"}},columns:[{valueType:"group",columns:[{title:"Condition",name:"condition",fieldProps:{placeholder:"Please enter a condition"},width:"md",rules:[{required:!0}]}]}]}]},{type:"action",icon:"FunctionOutlined",title:"Action",modalWidth:420,desc:"Obtain or process data by calling backend interfaces or methods.",formSchema:[{title:"Type",name:"type",rules:[{required:!0}]},{title:"Text",name:"text",rules:[{required:!0}]}]},{type:"transform",icon:"BlockOutlined",title:"Transform",modalWidth:420,desc:"Convert the input data",formSchema:[{title:"Type",name:"type",rules:[{required:!0}]},{title:"Text",name:"text",rules:[{required:!0}]}]}],Be="_node_layout_wrapper_xpd8g_1",Re="_tool_bar_xpd8g_13",Ge="_node_layout_xpd8g_1",Ue="_node_layout_body_xpd8g_29",w={node_layout_wrapper:Be,tool_bar:Re,node_layout:Ge,node_layout_body:Ue};function N(t){const{data:n,children:o,handler:a=!0}=t,s=n.values,d=s.nodeType,r=m.useMemo(()=>Fe(s.formData),[s.formData]),i=m.useMemo(()=>Y.find(_=>_.type===d),[d]),c=()=>{const _=e.jsx(We,{...t});if(a===!0)return _;if(typeof a=="function")return(a==null?void 0:a(r))??_};return e.jsxs("div",{className:w.node_layout_wrapper,children:[e.jsx("div",{className:w.tool_bar,children:e.jsx(Ae,{id:t.id,data:n,formData:r,schemas:i==null?void 0:i.formSchema,editModalWidth:i==null?void 0:i.modalWidth})}),e.jsxs("div",{className:w.node_layout,children:[e.jsx("div",{className:w.node_layout_body,children:o==null?void 0:o(r)}),c()]})]})}const De="_ui_node_ciuuw_1",Le="_ui_node_header_ciuuw_1",Ve="_ui_node_body_ciuuw_7",He="_ui_node_text_ciuuw_10",T={ui_node:De,ui_node_header:Le,ui_node_body:Ve,ui_node_text:He},Qe=t=>e.jsx(N,{...t,children:n=>e.jsxs("div",{className:T.ui_node,children:[e.jsx("div",{className:T.ui_node_header,children:n.name}),e.jsx("div",{className:T.ui_node_body,children:e.jsx("div",{className:T.ui_node_text,children:n.text})})]})}),ze="_action_node_14v0w_1",Ke="_action_node_header_14v0w_1",Ye="_action_node_body_14v0w_7",Xe="_action_node_text_14v0w_10",j={action_node:ze,action_node_header:Ke,action_node_body:Ye,action_node_text:Xe},Ze=t=>e.jsx(N,{...t,children:n=>e.jsxs("div",{className:j.action_node,children:[e.jsx("div",{className:j.action_node_header,children:"Action Node"}),e.jsxs("div",{className:j.action_node_body,children:[e.jsx("div",{className:j.action_node_text,children:n.type}),e.jsx("div",{className:j.action_node_text,children:n.text})]})]})}),Je="_transform_node_1u43d_1",et="_transform_node_header_1u43d_1",tt="_transform_node_body_1u43d_7",nt="_transform_node_text_1u43d_10",g={transform_node:Je,transform_node_header:et,transform_node_body:tt,transform_node_text:nt},ot=t=>e.jsx(N,{...t,children:n=>e.jsxs("div",{className:g.transform_node,children:[e.jsx("div",{className:g.transform_node_header,children:"Transform Node"}),e.jsxs("div",{className:g.transform_node_body,children:[e.jsx("div",{className:g.transform_node_text,children:n.type}),e.jsx("div",{className:g.transform_node_text,children:n.text})]})]})}),st="_step_node_1riik_1",at="_step_node_header_1riik_1",dt="_step_node_body_1riik_7",rt="_step_node_text_1riik_11",it="_conditions_1riik_19",ct="_condition_handle_1riik_25",f={step_node:st,step_node_header:at,step_node_body:dt,step_node_text:rt,conditions:it,condition_handle:ct},lt=t=>{const{conditions:n=[],isConnectable:o}=t,{connectionEnable:a=!0,connectionTypes:s=Object.keys(P)}=t.data,d=s.includes("target"),r=s.includes("source");return e.jsxs(m.Fragment,{children:[a&&d&&e.jsx("div",{className:"flow_handle_left",children:e.jsx(S,{type:"target",position:k.Left,className:"flow_handle",isConnectable:o})}),a&&r&&e.jsx("div",{className:f.conditions,children:n.map((i,c)=>e.jsxs("div",{className:f.condition_handle,children:[e.jsx("span",{children:i.condition}),e.jsxs("div",{className:"flow_handle_right",children:[e.jsx(S,{type:"source",id:i.condition,position:k.Right,className:"flow_handle",isConnectable:o}),e.jsx(A,{})]})]},`key_${i.condition}_${c}`))})]})},G=t=>e.jsx(N,{...t,handler:n=>{const o=n.conditions;if(o!=null&&o.length)return e.jsx(lt,{...t,conditions:n.conditions})},children:n=>e.jsxs("div",{className:f.step_node,children:[e.jsx("div",{className:f.step_node_header,children:n.name}),e.jsx("div",{className:f.step_node_body,children:e.jsx("div",{className:f.step_node_text,children:n.text||n.description})})]})}),_t="_prompt_node_syq2g_1",ut="_prompt_node_header_syq2g_1",mt="_prompt_node_body_syq2g_7",pt="_prompt_node_text_syq2g_10",C={prompt_node:_t,prompt_node_header:ut,prompt_node_body:mt,prompt_node_text:pt},ht={text:"Text",prompt:"Prompt"},xt=t=>e.jsx(N,{...t,children:n=>e.jsxs("div",{className:C.prompt_node,children:[e.jsxs("div",{className:C.prompt_node_header,children:[ht[n.type]," Node"]}),e.jsx("div",{className:C.prompt_node_body,children:e.jsx("div",{className:C.prompt_node_text,children:n.text||n.prompt})})]})}),yt={ui:Qe,action:Ze,transform:ot,step:G,branch:G,prompt:xt},ft=t=>{const{fromX:n,fromY:o,toX:a,toY:s}=t;return e.jsxs("g",{children:[e.jsx("path",{fill:"none",stroke:"#0143EC",strokeWidth:2,className:"animated",d:`M${n},${o} C ${n} ${s} ${n} ${s} ${a},${s}`}),e.jsx("circle",{cx:a,cy:s,fill:"#fff",r:3,stroke:"#0143EC",strokeWidth:2})]})},vt="_nodes_1mo0o_1",jt="_node_item_1mo0o_4",gt="_node_icon_1mo0o_14",Nt="_node_item_body_1mo0o_17",bt="_node_title_1mo0o_25",wt="_node_desc_1mo0o_30",y={nodes:vt,node_item:jt,node_icon:gt,node_item_body:Nt,node_title:bt,node_desc:wt},Tt=t=>{const{onNodeClick:n}=t,{role:o}=B(),a=m.useMemo(()=>Y.filter(s=>o==="parent"?s.type==="step":s.type!=="step"),[o]);return e.jsx("div",{className:y.nodes,children:a.map(s=>{const d=ce[s.icon];return e.jsx(E,{title:`Add ${s.title} Node`,width:s.modalWidth,destroyOnHidden:!0,okText:"Add Node",trigger:e.jsxs("div",{className:y.node_item,children:[e.jsx("div",{className:y.node_icon,children:e.jsx(d,{})}),e.jsxs("div",{className:y.node_item_body,children:[e.jsx("div",{className:y.node_title,children:s.title}),e.jsx("div",{className:y.node_desc,children:s.desc})]})]}),children:e.jsx(K,{schemas:s.formSchema,onSubmit:async r=>{const i=s.type;n==null||n({...r,nodeType:i})}})},s.type)})})},Ct=t=>{const{open:n,trigger:o,onClose:a}=Ne(t.trigger),s=u(d=>{var r;a(),(r=t.onChange)==null||r.call(t,d)});return e.jsxs(m.Fragment,{children:[e.jsx(le,{open:n,width:320,destroyOnHidden:!0,title:t.title,onClose:a,rootClassName:"shopify",children:e.jsx(Tt,{onNodeClick:s})}),o]})},St="_add_btn_z3xq6_1",kt={add_btn:St},Et=()=>{const{insertNodes:t}=B(),n=u(o=>{const{nodeType:a}=o,s=`${a}_${_e()}`;t([{id:s,type:a,data:{values:o},position:{x:0,y:0}}])});return e.jsx(Ct,{title:"What triggers this workflow?",onChange:n,trigger:e.jsx("div",{className:kt.add_btn,children:e.jsx(A,{})})})},Pt=m.forwardRef((t,n)=>{const{role:o="parent",initialNodes:a=[],initialEdges:s=[]}=t,[d,r,i]=ue(a),[c,_,x]=me(s),F=u(h=>{for(const p of h){if(d.length){const l=d.map(b=>b.position.x);p.position.x=Math.max(...l)+280}else{const l=p.data;l.connectionTypes||(l.connectionTypes=["source"])}d.push(p)}r([...d])}),q=u((h,p)=>{const l=d.findIndex(b=>b.id===h);l>-1&&(d[l].data=p,r(M(d)))}),$=u(h=>{const p=d.findIndex(l=>l.id===h);p>-1&&(d.splice(p,1),r([...d]))}),I=u(h=>{_(p=>pe(h,p).map(l=>({...l,...ke})))});return m.useImperativeHandle(n,()=>({getData:()=>M({nodes:d,edges:c})})),e.jsx(V.Provider,{value:{role:o,insertNodes:F,deleteNode:$,updateNodeData:q},children:e.jsx("div",{className:"ai_work_flow",children:e.jsx(he,{children:e.jsxs(xe,{fitView:!0,nodes:d,edges:c,minZoom:.5,nodeTypes:yt,onConnect:I,onNodesChange:i,onEdgesChange:x,connectionLineComponent:ft,children:[e.jsx(ye,{size:2,color:"#ccc",bgColor:"#f6f6f6"}),e.jsx(Et,{}),e.jsx(fe,{})]})})})})});export{Pt as default};
