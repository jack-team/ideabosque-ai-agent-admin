const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CJ-PvyeF.js","assets/libs-DVH06oKf.js","assets/index-DHrhuTJB.js","assets/index-DI1MWXAu.js","assets/index-BYOdb8PH.css","assets/index-BQD2aveu.js","assets/workflow-DzDxRJlq.js","assets/index-v6ouLxXC.css"])))=>i.map(i=>d[i]);
import{j as i,q as R,s as C,b as m,u as v,h as O,A as T,t as A,m as w,w as I,n as P}from"./libs-DVH06oKf.js";import{i as z,a as F}from"./workflow-DzDxRJlq.js";import{S as j,_ as k}from"./index-DI1MWXAu.js";import{S as V}from"./index-BQD2aveu.js";const W=e=>{const{loading:n=!1,children:t}=e;return i.jsxs("div",{className:"spin-box",children:[t,n?i.jsx("div",{className:"spin-box-loading",children:i.jsx(j,{size:48})}):null]})};var M=C();const h=R(M),S=e=>{const n=e.valueType,t=e.dependencys||[],s={valueType:n,width:e.width,title:e.title,tooltip:e.tooltip,dataIndex:e.name,valueEnum:e.valueEnum,fieldProps:e.fieldProps,initialValue:e.initialValue,formItemProps:{rules:e.rules}};return e.columns&&(s.columns=e.columns.map(S)),t.length&&(s.valueType="dependency",s.name=t.map(o=>o.name),s.columns=o=>t.filter(({name:l,values:r=[]})=>r.find(c=>c===o[l])).reduce((l,r)=>{const c=r.renders||[];return[...l,...c.map(S)]},[])),s},q=(e,n={})=>(e.forEach(t=>{var s;t.valueEnum&&(n=Object.assign(n,t.valueEnum)),(s=t.dependencys)==null||s.forEach(o=>{q(o.renders,n)})}),n),H=(e,n=[])=>(e.forEach(t=>{const s=t.dependencys||[],o=t.valueType||"text";s.length?s.forEach(a=>{H(a.renders,n)}):n.push({type:o,name:t.name})}),n),J=(e={})=>(e=h(e),Object.keys(e).reduce((n,t)=>({...n,[t]:e[t].value}),{})),$=(e,n,t)=>(Object.keys(e).map(s=>{const o=n.find(c=>c.name===s),a=e[s],l=(o==null?void 0:o.type)||"text",r={_type_:l,value:a};l==="select"&&(r.label=t[a]),e[s]=r}),e),_=(e,n,t)=>{var g;const s=e.id,o=e.data.values,a=J(o.formData),l=n.filter(p=>p.source===s),{conditions:r=[],...c}=a,d={id:s,type:o.nodeType};return o.stepRealData&&(d.detail=o.stepRealData),r.length?d.conditions=r.map(p=>{var u,y;let f=(u=l.find(x=>x.sourceHandle===p.condition))==null?void 0:u.target;return!f&&(t!=null&&t.conditions)&&(f=(y=t.conditions.find(x=>x.condition===p.condition))==null?void 0:y.nextStep),{...p,nextStep:f}}):(d.formData=c,d.nextStep=((g=l[0])==null?void 0:g.target)||(t==null?void 0:t.nextStep)),d},U="_loading_1cv3a_1",B="_container_1cv3a_7",D={loading:U,container:B},L=m.lazy(()=>k(()=>import("./index-CJ-PvyeF.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]))),G=m.forwardRef((e,n)=>{const{detail:t}=e,s=m.useRef(null),o=m.useMemo(()=>JSON.parse(t.flowRelationship??"{}"),[t.flowRelationship]),a=v(()=>{var p;const l=(p=s.current)==null?void 0:p.getData(),{nodes:r=[],edges:c=[]}=h(l);return{flowContext:r.map(f=>_(f,c)).map(f=>{const{detail:u,...y}=f,x=(u==null?void 0:u.nodes)||[],N=(u==null?void 0:u.edges)||[],E=x.map(b=>_(b,N,f));return{...y,details:E}}),flowRelationship:l}});return m.useImperativeHandle(n,()=>({getData:a})),i.jsx(O,{className:"shopify full-content",children:i.jsx("div",{className:D.container,children:i.jsx(m.Suspense,{fallback:i.jsx("div",{className:"lazy-loading",children:i.jsx(j,{size:48})}),children:i.jsx(L,{ref:s,initialNodes:o.nodes,initialEdges:o.edges})})})})});function K(){const{message:e}=T.useApp(),n=A(),t=m.useRef(null),[s,o]=w(!1),[a,l]=w(),r=v(async()=>{const d=await F({flowSnippetUuid:n.uid,flowSnippetVersionUuid:n.vid});l(d.flowSnippet)}),c=v(async()=>{var g;const d=(g=t.current)==null?void 0:g.getData();o(!0),await z({...a,flowContext:JSON.stringify(d.flowContext),flowRelationship:JSON.stringify(d.flowRelationship)}),e.success("Workflow saved successfully"),o(!1)});return I(r),i.jsx(P,{title:a==null?void 0:a.flowName,className:"shopify full-screen",loading:!a&&i.jsx("div",{className:D.loading,children:i.jsx(j,{size:36})}),extra:a?i.jsx(V,{type:"primary",className:"shopify",onClick:c,children:"Save"}):null,children:i.jsx(W,{loading:s,children:a?i.jsx(G,{ref:t,detail:a}):null})})}const ee=Object.freeze(Object.defineProperty({__proto__:null,default:K},Symbol.toStringTag,{value:"Module"}));export{q as a,H as b,J as c,h as d,S as g,ee as i,$ as t};
